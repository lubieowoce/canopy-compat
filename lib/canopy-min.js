"use strict";var Canopy={};Canopy.extend=function(t,e){if(!t||!e)return t;for(var s in e)t[s]!==e[s]&&(t[s]=e[s]);return t},Canopy.extend(Canopy,{Builders:{},compile:function(t,e){var s=new this.Compiler(t,e);return s.toSource()},forEach:function(t,e,s){for(var i=0,n=t.length;n>i;i++)e.call(s,t[i],i)},formatError:function(t,e,s){for(var i=t.split(/\n/g),n=0,_=0;e>=_;)_+=i[n].length+1,n+=1;var f="Line "+n+": expected "+s.join(", ")+"\n",h=i[n-1];for(f+=h+"\n",_-=h.length+1;e>_;)f+=" ",_+=1;return f+"^"},inherit:function(t,e){var s=function(){};s.prototype=e.prototype,t.prototype=new s,t.prototype.constructor=t}}),function(){var t=function(t,e){if(!t||!e)return t;for(var s in e)t[s]!==e[s]&&(t[s]=e[s]);return t},e=function(t,e,s){for(var i=t.split(/\n/g),n=0,_=0;e>=_;)_+=i[n].length+1,n+=1;var f="Line "+n+": expected "+s.join(", ")+"\n",h=i[n-1];for(f+=h+"\n",_-=h.length+1;e>_;)f+=" ",_+=1;return f+"^"},s=function(t,e){var s=function(){};s.prototype=e.prototype,t.prototype=new s,t.prototype.constructor=t},i=function(t,e,s){this.text=t,this.offset=e,this.elements=s||[]};i.prototype.forEach=function(t,e){for(var s=this.elements,i=0,n=s.length;n>i;i++)t.call(e,s[i],i,s)};var n=function(t,e,s){i.apply(this,arguments),this.grammar_name=s[1],this.rules=s[2]};s(n,i);var _=function(t,e,s){i.apply(this,arguments),this.grammar_rule=s[1]};s(_,i);var f=function(t,e,s){i.apply(this,arguments),this.object_identifier=s[3]};s(f,i);var h=function(t,e,s){i.apply(this,arguments),this.identifier=s[0],this.assignment=s[1],this.parsing_expression=s[2]};s(h,i);var o=function(t,e,s){i.apply(this,arguments),this.parsing_expression=s[2]};s(o,i);var r=function(t,e,s){i.apply(this,arguments),this.first_part=s[0],this.choice_part=s[0],this.rest=s[1]};s(r,i);var a=function(t,e,s){i.apply(this,arguments),this.expression=s[3],this.choice_part=s[3]};s(a,i);var u=function(t,e,s){i.apply(this,arguments),this.type_tag=s[1]};s(u,i);var l=function(t,e,s){i.apply(this,arguments),this.actionable_expression=s[0],this.action_tag=s[2]};s(l,i);var c=function(t,e,s){i.apply(this,arguments),this.actionable_expression=s[2]};s(c,i);var p=function(t,e,s){i.apply(this,arguments),this.identifier=s[1]};s(p,i);var d=function(t,e,s){i.apply(this,arguments),this.object_identifier=s[1]};s(d,i);var g=function(t,e,s){i.apply(this,arguments),this.first_part=s[0],this.sequence_part=s[0],this.rest=s[1]};s(g,i);var m=function(t,e,s){i.apply(this,arguments),this.expression=s[1],this.sequence_part=s[1]};s(m,i);var x=function(t,e,s){i.apply(this,arguments),this.expression=s[1]};s(x,i);var v=function(t,e,s){i.apply(this,arguments),this.atom=s[0]};s(v,i);var b=function(t,e,s){i.apply(this,arguments),this.atom=s[0],this.quantifier=s[1]};s(b,i);var w=function(t,e,s){i.apply(this,arguments),this.predicate=s[0],this.atom=s[1]};s(w,i);var y=function(t,e,s){i.apply(this,arguments),this.identifier=s[0]};s(y,i);var N=function(t,e,s){i.apply(this,arguments),this.identifier=s[0]};s(N,i);var S=function(t,e,s){i.apply(this,arguments),this.identifier=s[0]};s(S,i);var C=function(t,e,s){i.apply(this,arguments),this.identifier=s[1]};s(C,i);var L={},z={_read_grammar:function(){var e=L,s=this._offset;this._cache._grammar=this._cache._grammar||{};var f=this._cache._grammar[s];if(f)return this._offset=f[1],f[0];for(var h=this._offset,o=Array(4),r=L,a=0,u=this._offset,l=[],c=!0;c!==L;)c=this._read___(),c!==L&&(l.push(c),--a);if(0>=a?(r=new i(this._input.substring(u,this._offset),u,l),this._offset=this._offset):r=L,r!==L){o[0]=r;var p=L;if(p=this._read_grammar_name(),p!==L){o[1]=p;for(var d=L,g=1,m=this._offset,x=[],v=!0;v!==L;){for(var b=this._offset,w=Array(2),y=L,N=0,S=this._offset,C=[],z=!0;z!==L;)z=this._read___(),z!==L&&(C.push(z),--N);if(0>=N?(y=new i(this._input.substring(S,this._offset),S,C),this._offset=this._offset):y=L,y!==L){w[0]=y;var A=L;A=this._read_grammar_rule(),A!==L?w[1]=A:(w=null,this._offset=b)}else w=null,this._offset=b;null===w?v=L:(v=new _(this._input.substring(b,this._offset),b,w),this._offset=this._offset),v!==L&&(x.push(v),--g)}if(0>=g?(d=new i(this._input.substring(m,this._offset),m,x),this._offset=this._offset):d=L,d!==L){o[2]=d;for(var E=L,j=0,I=this._offset,q=[],P=!0;P!==L;)P=this._read___(),P!==L&&(q.push(P),--j);0>=j?(E=new i(this._input.substring(I,this._offset),I,q),this._offset=this._offset):E=L,E!==L?o[3]=E:(o=null,this._offset=h)}else o=null,this._offset=h}else o=null,this._offset=h}else o=null,this._offset=h;return null===o?e=L:(e=new n(this._input.substring(h,this._offset),h,o),this._offset=this._offset),t(e,this._types.Grammar),this._cache._grammar[s]=[e,this._offset],e},_read_grammar_name:function(){var t=L,e=this._offset;this._cache._grammar_name=this._cache._grammar_name||{};var s=this._cache._grammar_name[e];if(s)return this._offset=s[1],s[0];var n=this._offset,_=Array(4),h=L,o=null;if(this._offset<this._inputSize&&(o=this._input.substring(this._offset,this._offset+7)),null!==o&&o.toLowerCase()==="grammar".toLowerCase()?(h=new i(this._input.substring(this._offset,this._offset+7),this._offset),this._offset=this._offset+7):(h=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push("`grammar`")),h!==L){_[0]=h;var r=L,a=this._offset,u=null;if(this._offset<this._inputSize&&(u=this._input.substring(this._offset,this._offset+1)),":"===u?(r=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(r=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('":"')),r===L&&(r=new i(this._input.substring(a,a),a),this._offset=a),r!==L){_[1]=r;for(var l=L,c=1,p=this._offset,d=[],g=!0;g!==L;)g=this._read___(),g!==L&&(d.push(g),--c);if(0>=c?(l=new i(this._input.substring(p,this._offset),p,d),this._offset=this._offset):l=L,l!==L){_[2]=l;var m=L;m=this._read_object_identifier(),m!==L?_[3]=m:(_=null,this._offset=n)}else _=null,this._offset=n}else _=null,this._offset=n}else _=null,this._offset=n;return null===_?t=L:(t=new f(this._input.substring(n,this._offset),n,_),this._offset=this._offset),this._cache._grammar_name[e]=[t,this._offset],t},_read_grammar_rule:function(){var e=L,s=this._offset;this._cache._grammar_rule=this._cache._grammar_rule||{};var i=this._cache._grammar_rule[s];if(i)return this._offset=i[1],i[0];var n=this._offset,_=Array(3),f=L;if(f=this._read_identifier(),f!==L){_[0]=f;var o=L;if(o=this._read_assignment(),o!==L){_[1]=o;var r=L;r=this._read_parsing_expression(),r!==L?_[2]=r:(_=null,this._offset=n)}else _=null,this._offset=n}else _=null,this._offset=n;return null===_?e=L:(e=new h(this._input.substring(n,this._offset),n,_),this._offset=this._offset),t(e,this._types.GrammarRule),this._cache._grammar_rule[s]=[e,this._offset],e},_read_assignment:function(){var t=L,e=this._offset;this._cache._assignment=this._cache._assignment||{};var s=this._cache._assignment[e];if(s)return this._offset=s[1],s[0];for(var n=this._offset,_=Array(3),f=L,h=1,o=this._offset,r=[],a=!0;a!==L;)a=this._read___(),a!==L&&(r.push(a),--h);if(0>=h?(f=new i(this._input.substring(o,this._offset),o,r),this._offset=this._offset):f=L,f!==L){_[0]=f;var u=L,l=null;if(this._offset<this._inputSize&&(l=this._input.substring(this._offset,this._offset+2)),"<-"===l?(u=new i(this._input.substring(this._offset,this._offset+2),this._offset),this._offset=this._offset+2):(u=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"<-"')),u!==L){_[1]=u;for(var c=L,p=1,d=this._offset,g=[],m=!0;m!==L;)m=this._read___(),m!==L&&(g.push(m),--p);0>=p?(c=new i(this._input.substring(d,this._offset),d,g),this._offset=this._offset):c=L,c!==L?_[2]=c:(_=null,this._offset=n)}else _=null,this._offset=n}else _=null,this._offset=n;return null===_?t=L:(t=new i(this._input.substring(n,this._offset),n,_),this._offset=this._offset),this._cache._assignment[e]=[t,this._offset],t},_read_parsing_expression:function(){var t=L,e=this._offset;this._cache._parsing_expression=this._cache._parsing_expression||{};var s=this._cache._parsing_expression[e];if(s)return this._offset=s[1],s[0];var i=this._offset;return t=this._read_choice_expression(),t===L&&(this._offset=i,t=this._read_choice_part(),t===L&&(this._offset=i)),this._cache._parsing_expression[e]=[t,this._offset],t},_read_parenthesised_expression:function(){var t=L,e=this._offset;this._cache._parenthesised_expression=this._cache._parenthesised_expression||{};var s=this._cache._parenthesised_expression[e];if(s)return this._offset=s[1],s[0];var n=this._offset,_=Array(5),f=L,h=null;if(this._offset<this._inputSize&&(h=this._input.substring(this._offset,this._offset+1)),"("===h?(f=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(f=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"("')),f!==L){_[0]=f;for(var r=L,a=0,u=this._offset,l=[],c=!0;c!==L;)c=this._read___(),c!==L&&(l.push(c),--a);if(0>=a?(r=new i(this._input.substring(u,this._offset),u,l),this._offset=this._offset):r=L,r!==L){_[1]=r;var p=L;if(p=this._read_parsing_expression(),p!==L){_[2]=p;for(var d=L,g=0,m=this._offset,x=[],v=!0;v!==L;)v=this._read___(),v!==L&&(x.push(v),--g);if(0>=g?(d=new i(this._input.substring(m,this._offset),m,x),this._offset=this._offset):d=L,d!==L){_[3]=d;var b=L,w=null;this._offset<this._inputSize&&(w=this._input.substring(this._offset,this._offset+1)),")"===w?(b=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(b=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('")"')),b!==L?_[4]=b:(_=null,this._offset=n)}else _=null,this._offset=n}else _=null,this._offset=n}else _=null,this._offset=n}else _=null,this._offset=n;return null===_?t=L:(t=new o(this._input.substring(n,this._offset),n,_),this._offset=this._offset),this._cache._parenthesised_expression[e]=[t,this._offset],t},_read_choice_expression:function(){var e=L,s=this._offset;this._cache._choice_expression=this._cache._choice_expression||{};var n=this._cache._choice_expression[s];if(n)return this._offset=n[1],n[0];var _=this._offset,f=Array(2),h=L;if(h=this._read_choice_part(),h!==L){f[0]=h;for(var o=L,u=1,l=this._offset,c=[],p=!0;p!==L;){for(var d=this._offset,g=Array(4),m=L,x=1,v=this._offset,b=[],w=!0;w!==L;)w=this._read___(),w!==L&&(b.push(w),--x);if(0>=x?(m=new i(this._input.substring(v,this._offset),v,b),this._offset=this._offset):m=L,m!==L){g[0]=m;var y=L,N=null;if(this._offset<this._inputSize&&(N=this._input.substring(this._offset,this._offset+1)),"/"===N?(y=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(y=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"/"')),y!==L){g[1]=y;for(var S=L,C=1,z=this._offset,A=[],E=!0;E!==L;)E=this._read___(),E!==L&&(A.push(E),--C);if(0>=C?(S=new i(this._input.substring(z,this._offset),z,A),this._offset=this._offset):S=L,S!==L){g[2]=S;var j=L;j=this._read_choice_part(),j!==L?g[3]=j:(g=null,this._offset=d)}else g=null,this._offset=d}else g=null,this._offset=d}else g=null,this._offset=d;null===g?p=L:(p=new a(this._input.substring(d,this._offset),d,g),this._offset=this._offset),p!==L&&(c.push(p),--u)}0>=u?(o=new i(this._input.substring(l,this._offset),l,c),this._offset=this._offset):o=L,o!==L?f[1]=o:(f=null,this._offset=_)}else f=null,this._offset=_;return null===f?e=L:(e=new r(this._input.substring(_,this._offset),_,f),this._offset=this._offset),t(e,this._types.Choice),this._cache._choice_expression[s]=[e,this._offset],e},_read_choice_part:function(){var e=L,s=this._offset;this._cache._choice_part=this._cache._choice_part||{};var n=this._cache._choice_part[s];if(n)return this._offset=n[1],n[0];var _=this._offset,f=Array(2),h=L,o=this._offset;if(h=this._read_action_expression(),h===L&&(this._offset=o,h=this._read_sequence_expression(),h===L&&(this._offset=o,h=this._read_sequence_part(),h===L&&(this._offset=o))),h!==L){f[0]=h;for(var r=L,a=this._offset,l=this._offset,c=Array(2),p=L,d=1,g=this._offset,m=[],x=!0;x!==L;)x=this._read___(),x!==L&&(m.push(x),--d);if(0>=d?(p=new i(this._input.substring(g,this._offset),g,m),this._offset=this._offset):p=L,p!==L){c[0]=p;var v=L;v=this._read_type_tag(),v!==L?c[1]=v:(c=null,this._offset=l)}else c=null,this._offset=l;null===c?r=L:(r=new u(this._input.substring(l,this._offset),l,c),this._offset=this._offset),r===L&&(r=new i(this._input.substring(a,a),a),this._offset=a),r!==L?f[1]=r:(f=null,this._offset=_)}else f=null,this._offset=_;return null===f?e=L:(e=new i(this._input.substring(_,this._offset),_,f),this._offset=this._offset),t(e,this._types.ChoicePart),this._cache._choice_part[s]=[e,this._offset],e},_read_action_expression:function(){var e=L,s=this._offset;this._cache._action_expression=this._cache._action_expression||{};var n=this._cache._action_expression[s];if(n)return this._offset=n[1],n[0];var _=this._offset,f=Array(3),h=L;if(h=this._read_actionable_expression(),h!==L){f[0]=h;for(var o=L,r=1,a=this._offset,u=[],c=!0;c!==L;)c=this._read___(),c!==L&&(u.push(c),--r);if(0>=r?(o=new i(this._input.substring(a,this._offset),a,u),this._offset=this._offset):o=L,o!==L){f[1]=o;var p=L;p=this._read_action_tag(),p!==L?f[2]=p:(f=null,this._offset=_)}else f=null,this._offset=_}else f=null,this._offset=_;return null===f?e=L:(e=new l(this._input.substring(_,this._offset),_,f),this._offset=this._offset),t(e,this._types.Action),this._cache._action_expression[s]=[e,this._offset],e},_read_actionable_expression:function(){var t=L,e=this._offset;this._cache._actionable_expression=this._cache._actionable_expression||{};var s=this._cache._actionable_expression[e];if(s)return this._offset=s[1],s[0];var n=this._offset,_=this._offset,f=Array(5),h=L,o=null;if(this._offset<this._inputSize&&(o=this._input.substring(this._offset,this._offset+1)),"("===o?(h=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(h=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"("')),h!==L){f[0]=h;for(var r=L,a=0,u=this._offset,l=[],p=!0;p!==L;)p=this._read___(),p!==L&&(l.push(p),--a);if(0>=a?(r=new i(this._input.substring(u,this._offset),u,l),this._offset=this._offset):r=L,r!==L){f[1]=r;var d=L;if(d=this._read_actionable_expression(),d!==L){f[2]=d;for(var g=L,m=0,x=this._offset,v=[],b=!0;b!==L;)b=this._read___(),b!==L&&(v.push(b),--m);if(0>=m?(g=new i(this._input.substring(x,this._offset),x,v),this._offset=this._offset):g=L,g!==L){f[3]=g;var w=L,y=null;this._offset<this._inputSize&&(y=this._input.substring(this._offset,this._offset+1)),")"===y?(w=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(w=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('")"')),w!==L?f[4]=w:(f=null,this._offset=_)}else f=null,this._offset=_}else f=null,this._offset=_}else f=null,this._offset=_}else f=null,this._offset=_;return null===f?t=L:(t=new c(this._input.substring(_,this._offset),_,f),this._offset=this._offset),t===L&&(this._offset=n,t=this._read_sequence_expression(),t===L&&(this._offset=n,t=this._read_repeated_atom(),t===L&&(this._offset=n,t=this._read_terminal_node(),t===L&&(this._offset=n)))),this._cache._actionable_expression[e]=[t,this._offset],t},_read_action_tag:function(){var t=L,e=this._offset;this._cache._action_tag=this._cache._action_tag||{};var s=this._cache._action_tag[e];if(s)return this._offset=s[1],s[0];var n=this._offset,_=Array(2),f=L,h=null;if(this._offset<this._inputSize&&(h=this._input.substring(this._offset,this._offset+1)),"%"===h?(f=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(f=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"%"')),f!==L){_[0]=f;var o=L;o=this._read_identifier(),o!==L?_[1]=o:(_=null,this._offset=n)}else _=null,this._offset=n;return null===_?t=L:(t=new p(this._input.substring(n,this._offset),n,_),this._offset=this._offset),this._cache._action_tag[e]=[t,this._offset],t},_read_type_tag:function(){var t=L,e=this._offset;this._cache._type_tag=this._cache._type_tag||{};var s=this._cache._type_tag[e];if(s)return this._offset=s[1],s[0];var n=this._offset,_=Array(3),f=L,h=null;if(this._offset<this._inputSize&&(h=this._input.substring(this._offset,this._offset+1)),"<"===h?(f=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(f=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"<"')),f!==L){_[0]=f;var o=L;if(o=this._read_object_identifier(),o!==L){_[1]=o;var r=L,a=null;this._offset<this._inputSize&&(a=this._input.substring(this._offset,this._offset+1)),">"===a?(r=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(r=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('">"')),r!==L?_[2]=r:(_=null,this._offset=n)}else _=null,this._offset=n}else _=null,this._offset=n;return null===_?t=L:(t=new d(this._input.substring(n,this._offset),n,_),this._offset=this._offset),this._cache._type_tag[e]=[t,this._offset],t},_read_sequence_expression:function(){var e=L,s=this._offset;this._cache._sequence_expression=this._cache._sequence_expression||{};var n=this._cache._sequence_expression[s];if(n)return this._offset=n[1],n[0];var _=this._offset,f=Array(2),h=L;if(h=this._read_sequence_part(),h!==L){f[0]=h;for(var o=L,r=1,a=this._offset,u=[],l=!0;l!==L;){for(var c=this._offset,p=Array(2),d=L,x=1,v=this._offset,b=[],w=!0;w!==L;)w=this._read___(),w!==L&&(b.push(w),--x);if(0>=x?(d=new i(this._input.substring(v,this._offset),v,b),this._offset=this._offset):d=L,d!==L){p[0]=d;var y=L;y=this._read_sequence_part(),y!==L?p[1]=y:(p=null,this._offset=c)}else p=null,this._offset=c;null===p?l=L:(l=new m(this._input.substring(c,this._offset),c,p),this._offset=this._offset),l!==L&&(u.push(l),--r)}0>=r?(o=new i(this._input.substring(a,this._offset),a,u),this._offset=this._offset):o=L,o!==L?f[1]=o:(f=null,this._offset=_)}else f=null,this._offset=_;return null===f?e=L:(e=new g(this._input.substring(_,this._offset),_,f),this._offset=this._offset),t(e,this._types.Sequence),this._cache._sequence_expression[s]=[e,this._offset],e},_read_sequence_part:function(){var e=L,s=this._offset;this._cache._sequence_part=this._cache._sequence_part||{};var n=this._cache._sequence_part[s];if(n)return this._offset=n[1],n[0];var _=this._offset,f=Array(2),h=L,o=this._offset;if(h=this._read_label(),h===L&&(h=new i(this._input.substring(o,o),o),this._offset=o),h!==L){f[0]=h;var r=L,a=this._offset;r=this._read_maybe_atom(),r===L&&(this._offset=a,r=this._read_repeated_atom(),r===L&&(this._offset=a,r=this._read_atom(),r===L&&(this._offset=a))),r!==L?f[1]=r:(f=null,this._offset=_)}else f=null,this._offset=_;return null===f?e=L:(e=new x(this._input.substring(_,this._offset),_,f),this._offset=this._offset),t(e,this._types.SequencePart),this._cache._sequence_part[s]=[e,this._offset],e},_read_maybe_atom:function(){var e=L,s=this._offset;this._cache._maybe_atom=this._cache._maybe_atom||{};var n=this._cache._maybe_atom[s];if(n)return this._offset=n[1],n[0];var _=this._offset,f=Array(2),h=L;if(h=this._read_atom(),h!==L){f[0]=h;var o=L,r=null;this._offset<this._inputSize&&(r=this._input.substring(this._offset,this._offset+1)),"?"===r?(o=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(o=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"?"')),o!==L?f[1]=o:(f=null,this._offset=_)}else f=null,this._offset=_;return null===f?e=L:(e=new v(this._input.substring(_,this._offset),_,f),this._offset=this._offset),t(e,this._types.Maybe),this._cache._maybe_atom[s]=[e,this._offset],e},_read_repeated_atom:function(){var e=L,s=this._offset;this._cache._repeated_atom=this._cache._repeated_atom||{};var n=this._cache._repeated_atom[s];if(n)return this._offset=n[1],n[0];var _=this._offset,f=Array(2),h=L;if(h=this._read_atom(),h!==L){f[0]=h;var o=L,r=this._offset,a=null;if(this._offset<this._inputSize&&(a=this._input.substring(this._offset,this._offset+1)),"*"===a?(o=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(o=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"*"')),o===L){this._offset=r;var u=null;this._offset<this._inputSize&&(u=this._input.substring(this._offset,this._offset+1)),"+"===u?(o=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(o=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"+"')),o===L&&(this._offset=r)}o!==L?f[1]=o:(f=null,this._offset=_)}else f=null,this._offset=_;return null===f?e=L:(e=new b(this._input.substring(_,this._offset),_,f),this._offset=this._offset),t(e,this._types.Repeat),this._cache._repeated_atom[s]=[e,this._offset],e},_read_atom:function(){var t=L,e=this._offset;this._cache._atom=this._cache._atom||{};var s=this._cache._atom[e];if(s)return this._offset=s[1],s[0];var i=this._offset;return t=this._read_parenthesised_expression(),t===L&&(this._offset=i,t=this._read_predicated_atom(),t===L&&(this._offset=i,t=this._read_reference_expression(),t===L&&(this._offset=i,t=this._read_terminal_node(),t===L&&(this._offset=i)))),this._cache._atom[e]=[t,this._offset],t},_read_terminal_node:function(){var t=L,e=this._offset;this._cache._terminal_node=this._cache._terminal_node||{};var s=this._cache._terminal_node[e];if(s)return this._offset=s[1],s[0];var i=this._offset;return t=this._read_string_expression(),t===L&&(this._offset=i,t=this._read_ci_string_expression(),t===L&&(this._offset=i,t=this._read_char_class_expression(),t===L&&(this._offset=i,t=this._read_any_char_expression(),t===L&&(this._offset=i)))),this._cache._terminal_node[e]=[t,this._offset],t},_read_predicated_atom:function(){var e=L,s=this._offset;this._cache._predicated_atom=this._cache._predicated_atom||{};var n=this._cache._predicated_atom[s];if(n)return this._offset=n[1],n[0];var _=this._offset,f=Array(2),h=L,o=this._offset,r=null;if(this._offset<this._inputSize&&(r=this._input.substring(this._offset,this._offset+1)),"&"===r?(h=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(h=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"&"')),h===L){this._offset=o;var a=null;this._offset<this._inputSize&&(a=this._input.substring(this._offset,this._offset+1)),"!"===a?(h=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(h=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"!"')),h===L&&(this._offset=o)}if(h!==L){f[0]=h;var u=L;u=this._read_atom(),u!==L?f[1]=u:(f=null,this._offset=_)}else f=null,this._offset=_;return null===f?e=L:(e=new w(this._input.substring(_,this._offset),_,f),this._offset=this._offset),t(e,this._types.Predicate),this._cache._predicated_atom[s]=[e,this._offset],e},_read_reference_expression:function(){var e=L,s=this._offset;this._cache._reference_expression=this._cache._reference_expression||{};var n=this._cache._reference_expression[s];if(n)return this._offset=n[1],n[0];var _=this._offset,f=Array(2),h=L;if(h=this._read_identifier(),h!==L){f[0]=h;var o=L,r=this._offset;o=this._read_assignment(),this._offset=r,o===L?(o=new i(this._input.substring(this._offset,this._offset),this._offset),this._offset=this._offset):o=L,o!==L?f[1]=o:(f=null,this._offset=_)}else f=null,this._offset=_;return null===f?e=L:(e=new y(this._input.substring(_,this._offset),_,f),this._offset=this._offset),t(e,this._types.Reference),this._cache._reference_expression[s]=[e,this._offset],e},_read_string_expression:function(){var e=L,s=this._offset;this._cache._string_expression=this._cache._string_expression||{};var n=this._cache._string_expression[s];if(n)return this._offset=n[1],n[0];var _=this._offset,f=this._offset,h=Array(3),o=L,r=null;if(this._offset<this._inputSize&&(r=this._input.substring(this._offset,this._offset+1)),'"'===r?(o=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(o=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push("'\"'")),o!==L){h[0]=o;for(var a=L,u=0,l=this._offset,c=[],p=!0;p!==L;){var d=this._offset,g=this._offset,m=Array(2),x=L,v=null;if(this._offset<this._inputSize&&(v=this._input.substring(this._offset,this._offset+1)),"\\"===v?(x=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(x=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"\\\\"')),x!==L){m[0]=x;var b=L;this._offset<this._inputSize?(b=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(b=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push("<any char>")),b!==L?m[1]=b:(m=null,this._offset=g)}else m=null,this._offset=g;if(null===m?p=L:(p=new i(this._input.substring(g,this._offset),g,m),this._offset=this._offset),p===L){this._offset=d;var w=null;this._offset<this._inputSize&&(w=this._input.substring(this._offset,this._offset+1)),null!==w&&/^[^"]/.test(w)?(p=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(p=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('[^"]')),p===L&&(this._offset=d)}p!==L&&(c.push(p),--u)}if(0>=u?(a=new i(this._input.substring(l,this._offset),l,c),this._offset=this._offset):a=L,a!==L){h[1]=a;var y=L,N=null;this._offset<this._inputSize&&(N=this._input.substring(this._offset,this._offset+1)),'"'===N?(y=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(y=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push("'\"'")),y!==L?h[2]=y:(h=null,this._offset=f)}else h=null,this._offset=f}else h=null,this._offset=f;if(null===h?e=L:(e=new i(this._input.substring(f,this._offset),f,h),this._offset=this._offset),e===L){this._offset=_;var S=this._offset,C=Array(3),z=L,A=null;if(this._offset<this._inputSize&&(A=this._input.substring(this._offset,this._offset+1)),"'"===A?(z=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(z=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"\'"')),z!==L){C[0]=z;for(var E=L,j=0,I=this._offset,q=[],P=!0;P!==L;){var M=this._offset,T=this._offset,k=Array(2),R=L,V=null;if(this._offset<this._inputSize&&(V=this._input.substring(this._offset,this._offset+1)),"\\"===V?(R=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(R=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"\\\\"')),R!==L){k[0]=R;var G=L;this._offset<this._inputSize?(G=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(G=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push("<any char>")),G!==L?k[1]=G:(k=null,this._offset=T)}else k=null,this._offset=T;if(null===k?P=L:(P=new i(this._input.substring(T,this._offset),T,k),this._offset=this._offset),P===L){this._offset=M;var B=null;this._offset<this._inputSize&&(B=this._input.substring(this._offset,this._offset+1)),null!==B&&/^[^']/.test(B)?(P=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(P=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push("[^']")),P===L&&(this._offset=M)}P!==L&&(q.push(P),--j)}if(0>=j?(E=new i(this._input.substring(I,this._offset),I,q),this._offset=this._offset):E=L,E!==L){C[1]=E;var Z=L,F=null;this._offset<this._inputSize&&(F=this._input.substring(this._offset,this._offset+1)),"'"===F?(Z=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(Z=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"\'"')),Z!==L?C[2]=Z:(C=null,this._offset=S)}else C=null,this._offset=S}else C=null,this._offset=S;null===C?e=L:(e=new i(this._input.substring(S,this._offset),S,C),this._offset=this._offset),e===L&&(this._offset=_)}return t(e,this._types.String),this._cache._string_expression[s]=[e,this._offset],e},_read_ci_string_expression:function(){var e=L,s=this._offset;this._cache._ci_string_expression=this._cache._ci_string_expression||{};var n=this._cache._ci_string_expression[s];if(n)return this._offset=n[1],n[0];var _=this._offset,f=Array(3),h=L,o=null;if(this._offset<this._inputSize&&(o=this._input.substring(this._offset,this._offset+1)),"`"===o?(h=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(h=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"`"')),h!==L){f[0]=h;for(var r=L,a=0,u=this._offset,l=[],c=!0;c!==L;){var p=this._offset,d=this._offset,g=Array(2),m=L,x=null;if(this._offset<this._inputSize&&(x=this._input.substring(this._offset,this._offset+1)),"\\"===x?(m=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(m=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"\\\\"')),m!==L){g[0]=m;var v=L;this._offset<this._inputSize?(v=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(v=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push("<any char>")),v!==L?g[1]=v:(g=null,this._offset=d)}else g=null,this._offset=d;if(null===g?c=L:(c=new i(this._input.substring(d,this._offset),d,g),this._offset=this._offset),c===L){this._offset=p;var b=null;this._offset<this._inputSize&&(b=this._input.substring(this._offset,this._offset+1)),null!==b&&/^[^`]/.test(b)?(c=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(c=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push("[^`]")),c===L&&(this._offset=p)}c!==L&&(l.push(c),--a)}if(0>=a?(r=new i(this._input.substring(u,this._offset),u,l),this._offset=this._offset):r=L,r!==L){f[1]=r;var w=L,y=null;this._offset<this._inputSize&&(y=this._input.substring(this._offset,this._offset+1)),"`"===y?(w=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(w=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"`"')),w!==L?f[2]=w:(f=null,this._offset=_)}else f=null,this._offset=_}else f=null,
this._offset=_;return null===f?e=L:(e=new i(this._input.substring(_,this._offset),_,f),this._offset=this._offset),t(e,this._types.CIString),this._cache._ci_string_expression[s]=[e,this._offset],e},_read_any_char_expression:function(){var e=L,s=this._offset;this._cache._any_char_expression=this._cache._any_char_expression||{};var n=this._cache._any_char_expression[s];if(n)return this._offset=n[1],n[0];var _=null;return this._offset<this._inputSize&&(_=this._input.substring(this._offset,this._offset+1)),"."===_?(e=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(e=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"."')),t(e,this._types.AnyChar),this._cache._any_char_expression[s]=[e,this._offset],e},_read_char_class_expression:function(){var e=L,s=this._offset;this._cache._char_class_expression=this._cache._char_class_expression||{};var n=this._cache._char_class_expression[s];if(n)return this._offset=n[1],n[0];var _=this._offset,f=Array(4),h=L,o=null;if(this._offset<this._inputSize&&(o=this._input.substring(this._offset,this._offset+1)),"["===o?(h=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(h=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"["')),h!==L){f[0]=h;var r=L,a=this._offset,u=null;if(this._offset<this._inputSize&&(u=this._input.substring(this._offset,this._offset+1)),"^"===u?(r=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(r=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"^"')),r===L&&(r=new i(this._input.substring(a,a),a),this._offset=a),r!==L){f[1]=r;for(var l=L,c=1,p=this._offset,d=[],g=!0;g!==L;){var m=this._offset,x=this._offset,v=Array(2),b=L,w=null;if(this._offset<this._inputSize&&(w=this._input.substring(this._offset,this._offset+1)),"\\"===w?(b=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(b=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"\\\\"')),b!==L){v[0]=b;var y=L;this._offset<this._inputSize?(y=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(y=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push("<any char>")),y!==L?v[1]=y:(v=null,this._offset=x)}else v=null,this._offset=x;if(null===v?g=L:(g=new i(this._input.substring(x,this._offset),x,v),this._offset=this._offset),g===L){this._offset=m;var N=null;this._offset<this._inputSize&&(N=this._input.substring(this._offset,this._offset+1)),null!==N&&/^[^\]]/.test(N)?(g=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(g=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push("[^\\]]")),g===L&&(this._offset=m)}g!==L&&(d.push(g),--c)}if(0>=c?(l=new i(this._input.substring(p,this._offset),p,d),this._offset=this._offset):l=L,l!==L){f[2]=l;var S=L,C=null;this._offset<this._inputSize&&(C=this._input.substring(this._offset,this._offset+1)),"]"===C?(S=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(S=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"]"')),S!==L?f[3]=S:(f=null,this._offset=_)}else f=null,this._offset=_}else f=null,this._offset=_}else f=null,this._offset=_;return null===f?e=L:(e=new i(this._input.substring(_,this._offset),_,f),this._offset=this._offset),t(e,this._types.CharClass),this._cache._char_class_expression[s]=[e,this._offset],e},_read_label:function(){var t=L,e=this._offset;this._cache._label=this._cache._label||{};var s=this._cache._label[e];if(s)return this._offset=s[1],s[0];var n=this._offset,_=Array(2),f=L;if(f=this._read_identifier(),f!==L){_[0]=f;var h=L,o=null;this._offset<this._inputSize&&(o=this._input.substring(this._offset,this._offset+1)),":"===o?(h=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(h=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('":"')),h!==L?_[1]=h:(_=null,this._offset=n)}else _=null,this._offset=n;return null===_?t=L:(t=new N(this._input.substring(n,this._offset),n,_),this._offset=this._offset),this._cache._label[e]=[t,this._offset],t},_read_object_identifier:function(){var t=L,e=this._offset;this._cache._object_identifier=this._cache._object_identifier||{};var s=this._cache._object_identifier[e];if(s)return this._offset=s[1],s[0];var n=this._offset,_=Array(2),f=L;if(f=this._read_identifier(),f!==L){_[0]=f;for(var h=L,o=0,r=this._offset,a=[],u=!0;u!==L;){var l=this._offset,c=Array(2),p=L,d=null;if(this._offset<this._inputSize&&(d=this._input.substring(this._offset,this._offset+1)),"."===d?(p=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(p=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"."')),p!==L){c[0]=p;var g=L;g=this._read_identifier(),g!==L?c[1]=g:(c=null,this._offset=l)}else c=null,this._offset=l;null===c?u=L:(u=new C(this._input.substring(l,this._offset),l,c),this._offset=this._offset),u!==L&&(a.push(u),--o)}0>=o?(h=new i(this._input.substring(r,this._offset),r,a),this._offset=this._offset):h=L,h!==L?_[1]=h:(_=null,this._offset=n)}else _=null,this._offset=n;return null===_?t=L:(t=new S(this._input.substring(n,this._offset),n,_),this._offset=this._offset),this._cache._object_identifier[e]=[t,this._offset],t},_read_identifier:function(){var t=L,e=this._offset;this._cache._identifier=this._cache._identifier||{};var s=this._cache._identifier[e];if(s)return this._offset=s[1],s[0];var n=this._offset,_=Array(2),f=L,h=null;if(this._offset<this._inputSize&&(h=this._input.substring(this._offset,this._offset+1)),null!==h&&/^[a-zA-Z_]/.test(h)?(f=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(f=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push("[a-zA-Z_]")),f!==L){_[0]=f;for(var o=L,r=0,a=this._offset,u=[],l=!0;l!==L;){var c=null;this._offset<this._inputSize&&(c=this._input.substring(this._offset,this._offset+1)),null!==c&&/^[a-zA-Z0-9_]/.test(c)?(l=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(l=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push("[a-zA-Z0-9_]")),l!==L&&(u.push(l),--r)}0>=r?(o=new i(this._input.substring(a,this._offset),a,u),this._offset=this._offset):o=L,o!==L?_[1]=o:(_=null,this._offset=n)}else _=null,this._offset=n;return null===_?t=L:(t=new i(this._input.substring(n,this._offset),n,_),this._offset=this._offset),this._cache._identifier[e]=[t,this._offset],t},_read___:function(){var t=L,e=this._offset;this._cache.___=this._cache.___||{};var s=this._cache.___[e];if(s)return this._offset=s[1],s[0];var n=this._offset,_=null;return this._offset<this._inputSize&&(_=this._input.substring(this._offset,this._offset+1)),null!==_&&/^[\s]/.test(_)?(t=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(t=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push("[\\s]")),t===L&&(this._offset=n,t=this._read_comment(),t===L&&(this._offset=n)),this._cache.___[e]=[t,this._offset],t},_read_comment:function(){var t=L,e=this._offset;this._cache._comment=this._cache._comment||{};var s=this._cache._comment[e];if(s)return this._offset=s[1],s[0];var n=this._offset,_=Array(2),f=L,h=null;if(this._offset<this._inputSize&&(h=this._input.substring(this._offset,this._offset+1)),"#"===h?(f=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(f=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push('"#"')),f!==L){_[0]=f;for(var o=L,r=0,a=this._offset,u=[],l=!0;l!==L;){var c=null;this._offset<this._inputSize&&(c=this._input.substring(this._offset,this._offset+1)),null!==c&&/^[^\n]/.test(c)?(l=new i(this._input.substring(this._offset,this._offset+1),this._offset),this._offset=this._offset+1):(l=L,this._offset>this._failure&&(this._failure=this._offset,this._expected=[]),this._offset===this._failure&&this._expected.push("[^\\n]")),l!==L&&(u.push(l),--r)}0>=r?(o=new i(this._input.substring(a,this._offset),a,u),this._offset=this._offset):o=L,o!==L?_[1]=o:(_=null,this._offset=n)}else _=null,this._offset=n;return null===_?t=L:(t=new i(this._input.substring(n,this._offset),n,_),this._offset=this._offset),this._cache._comment[e]=[t,this._offset],t}},A=function(t,e,s){this._input=t,this._inputSize=t.length,this._actions=e,this._types=s,this._offset=0,this._cache={},this._failure=0,this._expected=[]};A.prototype.parse=function(){var t=this._read_grammar();if(t!==L&&this._offset===this._inputSize)return t;throw 0===this._expected.length&&(this._failure=this._offset,this._expected.push("<EOF>")),this.constructor.lastError={offset:this._offset,expected:this._expected},new SyntaxError(e(this._input,this._failure,this._expected))};var E=function(t,e){e=e||{};var s=new A(t,e.actions,e.types);return s.parse()};t(A.prototype,z);var j={Grammar:z,Parser:A,parse:E};if("function"==typeof require&&"object"==typeof exports)t(exports,j),void 0!==Canopy&&(Canopy.MetaGrammar=j);else{var I=void 0!==this?this:window;I=I.Canopy=I.Canopy||{},I.MetaGrammar=j}}(),function(){var t=function(t,e){t?(this._parent=t,this._indentLevel=t._indentLevel):(this._buffer="",this._indentLevel=0),this._name=e,this._varIndex={},this._buffers={},this._currentBuffer=null,this._labels={}},e={address:"TreeNode",chunk:"String",elements:"List<TreeNode>",index:"int",remaining:"int"};t.create=function(e,s){var i=new t;return i.filename=e,i.pathsep=s,i},Canopy.extend(t.prototype,{serialize:function(){return this._buffers},_newBuffer:function(t){this._currentBuffer=this.filename.replace(/\.peg$/,this.pathsep+t+".java");var e=this.filename.replace(/\.peg$/,"").split(this.pathsep);this._buffers[this._currentBuffer]="package "+e.join(".")+";\n\n"},_write:function(t){return this._parent?this._parent._write(t):void(this._buffers[this._currentBuffer]+=t)},_indent:function(t,e){this._indentLevel+=1,t.call(e,this),this._indentLevel-=1},_newline:function(){this._write("\n")},_line:function(t,e){for(var s=this._indentLevel;s--;)this._write("    ");this._write(t),e!==!1&&this._write(";"),this._newline()},_quote:function(t){return t=t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r"),'"'+t+'"'},package_:function(t,e,s){this._grammarName=t.replace(/\./g,""),e.call(s,this)},syntaxNodeClass_:function(){this._newBuffer("TreeNode");for(var t=["ArrayList","EnumMap","Iterator","List","Map"],e=0,s=t.length;s>e;e++)this._line("import java.util."+t[e]);var i="TreeNode";return this._newline(),this._line("public class "+i+" implements Iterable<"+i+"> {",!1),this._indent(function(t){t._line("public String text"),t._line("public int offset"),t._line("public List<"+i+"> elements"),t._newline(),t._line("Map<Label, "+i+"> labelled"),t._newline(),t._line("public "+i+"() {",!1),t._indent(function(t){t._line('this("", -1, new ArrayList<'+i+">(0))")}),t._line("}",!1),t._newline(),t._line("public "+i+"(String text, int offset) {",!1),t._indent(function(t){t._line("this(text, offset, new ArrayList<"+i+">(0))")}),t._line("}",!1),t._newline(),t._line("public "+i+"(String text, int offset, List<"+i+"> elements) {",!1),t._indent(function(t){t.assign_("this.text","text"),t.assign_("this.offset","offset"),t.assign_("this.elements","elements"),t.assign_("this.labelled","new EnumMap<Label, "+i+">(Label.class)")}),t._line("}",!1),t._newline(),t._line("public "+i+" get(Label key) {",!1),t._indent(function(t){t.return_("labelled.get(key)")}),t._line("}",!1),t._newline(),t._line("public Iterator<"+i+"> iterator() {",!1),t._indent(function(t){t.return_("elements.iterator()")}),t._line("}",!1)}),this._line("}",!1),i},grammarModule_:function(t,e,s){this._newBuffer("CacheRecord"),this._line("class CacheRecord {",!1),this._indent(function(t){t._line("TreeNode node"),t._line("int tail"),t._newline(),t._line("CacheRecord(TreeNode node, int tail) {",!1),t._indent(function(t){t.assign_("this.node","node"),t.assign_("this.tail","tail")}),t._line("}",!1)}),this._line("}",!1),this._newBuffer("Actions"),this._line("import java.util.List"),this._newline(),this._line("public interface Actions {",!1),this._indent(function(e){for(var s=0,i=t.length;i>s;s++)e._line("public TreeNode "+t[s]+"(String input, int start, int end, List<TreeNode> elements)")}),this._line("}",!1),this._newBuffer("Grammar"),this._line("import java.util.ArrayList"),this._line("import java.util.HashMap"),this._line("import java.util.List"),this._line("import java.util.Map"),this._line("import java.util.regex.Pattern"),this._newline(),this._line("abstract class Grammar {",!1),this._indent(function(t){t.assign_("static TreeNode "+t.nullNode_(),"new TreeNode()"),t._newline(),t._line("int inputSize, offset, failure"),t._line("String input"),t._line("List<String> expected"),t._line("Map<Label, Map<Integer, CacheRecord>> cache"),t._line("Actions actions"),t._newline(),e.call(s,t)}),this._line("}",!1)},compileRegex_:function(t,e){var s=t.toRegExp(),i=s.source.replace(/^\^/,"\\A");this.assign_("private static Pattern "+e,"Pattern.compile("+this._quote(i)+")"),t.constName=e},parserClass_:function(t){this._newBuffer("ParseError"),this._line("public class ParseError extends Exception {",!1),this._indent(function(t){t._line("public ParseError(String message) {",!1),t._indent(function(t){t._line("super(message)")}),t._line("}",!1)}),this._line("}",!1),this._newBuffer(this._grammarName),this._line("import java.util.ArrayList"),this._line("import java.util.EnumMap"),this._line("import java.util.List"),this._line("import java.util.Map"),this._newline(),this._line("public class "+this._grammarName+" extends Grammar {",!1),this._indent(function(e){e._line("public "+this._grammarName+"(String input, Actions actions) {",!1),e._indent(function(t){t.assign_("this.input","input"),t.assign_("this.inputSize","input.length()"),t.assign_("this.actions","actions"),t.assign_("this.offset","0"),t.assign_("this.cache","new EnumMap<Label, Map<Integer, CacheRecord>>(Label.class)"),t.assign_("this.failure","0"),t.assign_("this.expected","new ArrayList<String>()")}),e._line("}",!1),e._newline(),e._line("public static TreeNode parse(String input, Actions actions) throws ParseError {",!1),e._indent(function(t){t.assign_(this._grammarName+" parser","new "+this._grammarName+"(input, actions)"),t.return_("parser.parse()")},this),e._line("}",!1),e._newline(),e._line("public static TreeNode parse(String input) throws ParseError {",!1),e._indent(function(t){t.return_("parse(input, null)")}),e._line("}",!1),e._newline(),e._line("private static String formatError(String input, int offset, List<String> expected) {",!1),e._indent(function(t){t.assign_("String[] lines",'input.split("\\n")'),t._line("int lineNo = 0, position = 0"),t._line("while (position <= offset) {",!1),t._indent(function(t){t._line("position += lines[lineNo].length() + 1"),t._line("lineNo += 1")}),t._line("}",!1),t.assign_("String message",'"Line " + lineNo + ": expected " + expected + "\\n"'),t.assign_("String line","lines[lineNo - 1]"),t._line('message += line + "\\n"'),t._line("position -= line.length() + 1"),t._line("while (position < offset) {",!1),t._indent(function(t){t._line('message += " "'),t._line("position += 1")}),t._line("}",!1),t.return_('message + "^"')}),e._line("}",!1),e._newline(),e._line("private TreeNode parse() throws ParseError {",!1),e._indent(function(e){e.jump_("TreeNode tree",t),e.if_("tree != "+e.nullNode_()+" && offset == inputSize",function(t){t.return_("tree")}),e.if_("expected.isEmpty()",function(t){t.assign_("failure","offset"),t.append_("expected",'"<EOF>"')}),e._line("throw new ParseError(formatError(input, failure, expected))")}),e._line("}",!1)},this),this._line("}",!1)},exports_:function(){var t=[];for(var e in this._labels)t.push(e);t=t.sort(),this._newBuffer("Label"),this._line("public enum Label {",!1),this._indent(function(e){for(var s=0,i=t.length;i>s;s++)e._line(t[s]+(i-1>s?",":""),!1)}),this._line("}",!1)},class_:function(e,s,i,n){this._newline(),this._line("class "+e+" extends "+s+" {",!1),new t(this,e)._indent(i,n),this._line("}",!1)},constructor_:function(t,e,s){this._line(this._name+"(String text, int offset, List<TreeNode> elements) {",!1),this._indent(function(t){t._line("super(text, offset, elements)"),e.call(s,t)},this),this._line("}",!1)},method_:function(e,s,i,n){this._newline(),this._line("TreeNode "+e+"() {",!1),new t(this)._indent(i,n),this._line("}",!1)},cache_:function(t,e,s){for(var i=this;i._parent;)i=i._parent;i._labels[t]=!0;var n=this.localVars_({address:this.nullNode_(),index:"offset"}),_=n.address,f=n.index;this.assign_("Map<Integer, CacheRecord> rule","cache.get(Label."+t+")"),this.if_("rule == null",function(e){e.assign_("rule","new HashMap<Integer, CacheRecord>()"),e._line("cache.put(Label."+t+", rule)")}),this.if_("rule.containsKey(offset)",function(t){t.assign_(_,"rule.get(offset).node"),t.assign_("offset","rule.get(offset).tail")},function(t){e.call(s,t,_),t._line("rule.put("+f+", new CacheRecord("+_+", offset))")}),this.return_(_)},attributes_:function(){},attribute_:function(t,e){for(var s=this;s._parent;)s=s._parent;s._labels[t]=!0,this._line("labelled.put(Label."+t+", "+e+")")},localVars_:function(t){var e={};for(var s in t)e[s]=this.localVar_(s,t[s]);return e},localVar_:function(t,s){this._varIndex[t]=this._varIndex[t]||0;var i=t+this._varIndex[t];return this._varIndex[t]+=1,this.assign_(e[t]+" "+i,void 0===s?this.nullNode_():s),i},chunk_:function(t){var e=this.localVar_("chunk",this.null_()),s="input",i="offset";return this.if_(i+" < inputSize",function(n){n._line(e+" = "+s+".substring("+i+", "+i+" + "+t+")")}),e},syntaxNode_:function(t,e,s,i,n,_){var f;n?(n="actions."+n,f=["input",e,s]):(n="new "+(_||"TreeNode"),f=["input.substring("+e+", "+s+")",e]),i&&f.push(i),this.assign_(t,n+"("+f.join(", ")+")"),this.assign_("offset",s)},ifNode_:function(t,e,s,i){this.if_(t+" != "+this.nullNode_(),e,s,i)},unlessNode_:function(t,e,s,i){this.if_(t+" == "+this.nullNode_(),e,s,i)},ifNull_:function(t,e,s,i){this.if_(t+" == null",e,s,i)},extendNode_:function(t,e){},failure_:function(t,e){e=this._quote(e),this.assign_(t,this.nullNode_()),this.if_("offset > failure",function(t){t.assign_("failure","offset"),t.assign_("expected","new ArrayList<String>()")}),this.if_("offset == failure",function(t){t.append_("expected",e)})},assign_:function(t,e){this._line(t+" = "+e)},jump_:function(t,e){this.assign_(t,"_read_"+e+"()")},conditional_:function(t,e,s,i,n){"function"!=typeof i&&(n=i,i=null),this._line(t+" ("+e+") {",!1),this._indent(s,n),i&&(this._line("} else {",!1),this._indent(i,n)),this._line("}",!1)},if_:function(t,e,s,i){this.conditional_("if",t,e,s,i)},whileNotNull_:function(t,e,s){this.conditional_("while",t+" != "+this.nullNode_(),e,s)},stringMatch_:function(t,e){return t+" != null && "+t+".equals("+this._quote(e)+")"},stringMatchCI_:function(t,e){return t+" != null && "+t+".toLowerCase().equals("+this._quote(e)+".toLowerCase())"},regexMatch_:function(t,e){return e+" != null && "+t+".matcher("+e+").matches()"},return_:function(t){this._line("return "+t)},arrayLookup_:function(t,e){return t+".get("+e+")"},append_:function(t,e,s){void 0===s?this._line(t+".add("+e+")"):this._line(t+".add("+s+", "+e+")")},decrement_:function(t){this._line("--"+t)},isZero_:function(t){return t+" <= 0"},hasChars_:function(){return"offset < inputSize"},nullNode_:function(){return"FAILURE"},offset_:function(){return"offset"},emptyList_:function(t){return"new ArrayList<TreeNode>("+(t?t:"")+")"},emptyString_:function(){return'""'},true_:function(){return'new TreeNode("", -1)'},null_:function(){return"null"}}),Canopy.Builders.Java=t}(),function(){var t=function(t,e,s){t?(this._parent=t,this._indentLevel=t._indentLevel):(this._buffer="",this._indentLevel=0),this._name=e,this._parentName=s,this._methodSeparator="",this._varIndex={}};t.create=function(e){var s=new t;return s.filename=e,s},Canopy.extend(t.prototype,{serialize:function(){var t={};return t[this._outputPathname()]=this._buffer,t},_outputPathname:function(){return this.filename.replace(/\.peg$/,".js")},_write:function(t){return this._parent?this._parent._write(t):void(this._buffer+=t)},_indent:function(t,e){this._indentLevel+=1,t.call(e,this),this._indentLevel-=1},_newline:function(){this._write("\n")},_line:function(t,e){for(var s=this._indentLevel;s--;)this._write("  ");this._write(t),e!==!1&&this._write(";"),this._newline()},_quote:function(t){return t=t.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\v/g,"\\v").replace(/\f/g,"\\f").replace(/\r/g,"\\r"),"'"+t+"'"},package_:function(t,e,s){this._line("(function() {",!1),this._indent(function(i){i._line("'use strict'"),i._newline(),i._line("var extend = "+Canopy.extend),i._newline(),i._line("var formatError = "+Canopy.formatError),i._newline(),i._line("var inherit = "+Canopy.inherit),this._grammarName=t,e.call(s,this)},this),this._line("})()")},syntaxNodeClass_:function(){var t="TreeNode";return this.function_("var "+t,["text","offset","elements"],function(t){t._line("this.text = text"),t._line("this.offset = offset"),t._line("this.elements = elements || []")}),this.function_(t+".prototype.forEach",["block","context"],function(t){t._line("for (var el = this.elements, i = 0, n = el.length; i < n; i++) {",!1),t._indent(function(t){t._line("block.call(context, el[i], i, el)")}),t._line("}",!1)}),t},grammarModule_:function(e,s,i){this._newline(),this.assign_("var "+this.nullNode_(),"{}"),this._newline(),this._line("var Grammar = {",!1),new t(this)._indent(s,i),this._newline(),this._line("}")},compileRegex_:function(){},parserClass_:function(t){this.function_("var Parser",["input","actions","types"],function(t){t.assign_("this._input","input"),t.assign_("this._inputSize","input.length"),t.assign_("this._actions","actions"),t.assign_("this._types","types"),t.assign_("this._offset","0"),t.assign_("this._cache","{}"),t.assign_("this._failure","0"),t.assign_("this._expected","[]")}),this.function_("Parser.prototype.parse",[],function(e){e.jump_("var tree",t),e.if_("tree !== "+e.nullNode_()+" && this._offset === this._inputSize",function(t){t.return_("tree")}),e.if_("this._expected.length === 0",function(t){t.assign_("this._failure","this._offset"),t.append_("this._expected","'<EOF>'")}),e.assign_("this.constructor.lastError","{offset: this._offset, expected: this._expected}"),e._line("throw new SyntaxError(formatError(this._input, this._failure, this._expected))")}),this.function_("var parse",["input","options"],function(t){t.assign_("options","options || {}"),t.assign_("var parser","new Parser(input, options.actions, options.types)"),t.return_("parser.parse()")}),this._line("extend(Parser.prototype, Grammar)"),this._newline()},exports_:function(){for(var t=this._grammarName,e=t.split("."),s=e.pop(),i=e.length,n=[],_=0;i>_;_++)n.push("typeof "+e.slice(0,_+1).join(".")+" !== 'undefined'");this.assign_("var exported","{Grammar: Grammar, Parser: Parser, parse: parse}"),this._newline(),this.if_("typeof require === 'function' && typeof exports === 'object'",function(e){e._line("extend(exports, exported)"),n.length>0&&e.if_(n.join(" &&"),function(e){e.assign_(t,"exported")})},function(t){t.assign_("var namespace","typeof this !== 'undefined' ? this : window");for(var n=0;i>n;n++)t.assign_("namespace","namespace."+e[n]+" = namespace."+e[n]+" || {}");t.assign_("namespace."+s,"exported")})},class_:function(e,s,i,n){var _=new t(this,e,s);i.call(n,_)},constructor_:function(t,e,s){this.function_("var "+this._name,t,function(t){t._line(this._parentName+".apply(this, arguments)"),e.call(s,t)},this),this._line("inherit("+this._name+", "+this._parentName+")")},function_:function(e,s,i,n){this._newline(),this._line(e+" = function("+s.join(", ")+") {",!1),new t(this,this._name,this._parentName)._indent(i,n),this._line("}")},method_:function(e,s,i,n){this._write(this._methodSeparator),this._methodSeparator=",\n\n",this._line(e+": function("+s.join(", ")+") {",!1),new t(this)._indent(i,n);for(var _=this._indentLevel;_--;)this._write("  ");this._write("}")},cache_:function(t,e,s){var i=this.localVars_({address:this.nullNode_(),index:"this._offset"}),n=i.address,_=i.index,f="this._cache._"+t,h=f+"["+_+"]";this.assign_(f,f+" || {}"),this.assign_("var cached",h),this.if_("cached",function(t){t.assign_("this._offset","cached[1]"),t.return_("cached[0]")}),e.call(s,this,n),this.assign_(h,"["+n+", this._offset]"),this.return_(n)},attributes_:function(){},attribute_:function(t,e){this.assign_("this['"+t+"']",e)},localVars_:function(t){var e,s={},i=[];for(var n in t)this._varIndex[n]=this._varIndex[n]||0,e=n+this._varIndex[n],this._varIndex[n]+=1,i.push(e+" = "+t[n]),s[n]=e;return this._line("var "+i.join(", ")),s},localVar_:function(t,e){this._varIndex[t]=this._varIndex[t]||0;var s=t+this._varIndex[t];return this._varIndex[t]+=1,this.assign_("var "+s,void 0===e?this.nullNode_():e),s},chunk_:function(t){var e=this.localVar_("chunk",this.null_()),s="this._input",i="this._offset";return this.if_(i+" < this._inputSize",function(n){n._line(e+" = "+s+".substring("+i+", "+i+" + "+t+")")}),e},syntaxNode_:function(t,e,s,i,n,_){var f;n?(n="this._actions."+n,f=["this._input",e,s]):(n="new "+(_||"TreeNode"),f=["this._input.substring("+e+", "+s+")",e]),i&&f.push(i),this.assign_(t,n+"("+f.join(", ")+")"),this.assign_("this._offset",s)},ifNode_:function(t,e,s,i){this.if_(t+" !== "+this.nullNode_(),e,s,i)},unlessNode_:function(t,e,s,i){this.if_(t+" === "+this.nullNode_(),e,s,i)},ifNull_:function(t,e,s,i){this.if_(t+" === null",e,s,i)},extendNode_:function(t,e){e&&this._line("extend("+t+", this._types."+e+")")},failure_:function(t,e){e=this._quote(e),this.assign_(t,this.nullNode_()),this.if_("this._offset > this._failure",function(t){t.assign_("this._failure","this._offset"),t.assign_("this._expected","[]")}),this.if_("this._offset === this._failure",function(t){t.append_("this._expected",e)})},assign_:function(t,e){this._line(t+" = "+e)},jump_:function(t,e){this.assign_(t,"this._read_"+e+"()")},conditional_:function(t,e,s,i,n){"function"!=typeof i&&(n=i,i=null),this._line(t+" ("+e+") {",!1),this._indent(s,n),i&&(this._line("} else {",!1),this._indent(i,n)),this._line("}",!1)},if_:function(t,e,s,i){this.conditional_("if",t,e,s,i)},whileNotNull_:function(t,e,s){this.conditional_("while",t+" !== "+this.nullNode_(),e,s)},stringMatch_:function(t,e){return t+" === "+this._quote(e)},stringMatchCI_:function(t,e){return t+" !== null && "+t+".toLowerCase() === "+this._quote(e)+".toLowerCase()"},regexMatch_:function(t,e){return e+" !== null && /"+t.source+"/.test("+e+")"},return_:function(t){this._line("return "+t)},arrayLookup_:function(t,e){return t+"["+e+"]"},append_:function(t,e,s){void 0===s?this._line(t+".push("+e+")"):this._line(t+"["+s+"] = "+e)},decrement_:function(t){this._line("--"+t)},isZero_:function(t){return t+" <= 0"},hasChars_:function(){return"this._offset < this._inputSize"},nullNode_:function(){return"FAILURE"},offset_:function(){return"this._offset"},emptyList_:function(t){return t?"new Array("+t+")":"[]"},emptyString_:function(){return"''"},true_:function(){return"true"},null_:function(){return"null"}}),Canopy.Builders.JavaScript=t}(),function(){var t=function(t,e){t?(this._parent=t,this._indentLevel=t._indentLevel):(this._buffer="",this._indentLevel=0),this._name=e,this._methodSeparator="",this._varIndex={}};t.create=function(e){var s=new t;return s.filename=e,s},Canopy.extend(t.prototype,{serialize:function(){var t={};return t[this._outputPathname()]=this._buffer,t},_outputPathname:function(){return this.filename.replace(/\.peg$/,".py")},_write:function(t){return this._parent?this._parent._write(t):void(this._buffer+=t)},_indent:function(t,e){this._indentLevel+=1,t.call(e,this),this._indentLevel-=1},_newline:function(){this._write("\n")},_line:function(t){for(var e=this._indentLevel;e--;)this._write("    ");this._write(t),this._newline()},_quote:function(t){return t=t.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/\x07/g,"\\a").replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\v/g,"\\v").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/\x1b/g,"\\e"),"'"+t+"'"},package_:function(t,e,s){this._line("from collections import defaultdict"),this._line("import re"),this._newline(),this._newline(),e.call(s,this)},syntaxNodeClass_:function(){var t="TreeNode";return this.class_(t,"object",function(t){t.method_("__init__",["text","offset","elements=None"],function(t){t.attribute_("text","text"),t.attribute_("offset","offset"),t.attribute_("elements","elements or []")}),t.method_("__iter__",[],function(t){t._line("for el in self.elements:"),t._indent(function(t){t._line("yield el")})})}),t},grammarModule_:function(t,e,s){this.class_("ParseError","SyntaxError",function(t){t._line("pass")}),this.assign_(this.nullNode_(),"object()"),this._newline(),this._newline(),this.class_("Grammar","object",e,s)},compileRegex_:function(t,e){var s=t.toRegExp();this.assign_(e,"re.compile("+this._quote(s.source)+")"),t.constName=e,this._methodSeparator="\n"},parserClass_:function(t){this.class_("Parser","Grammar",function(e){e.method_("__init__",["input","actions","types"],function(t){t.attribute_("_input","input"),t.attribute_("_input_size","len(input)"),t.attribute_("_actions","actions"),t.attribute_("_types","types"),t.attribute_("_offset","0"),t.attribute_("_cache","defaultdict(dict)"),t.attribute_("_failure","0"),t.attribute_("_expected","[]")}),e.method_("parse",[],function(e){e.jump_("tree",t),e.if_("tree is not "+e.nullNode_()+" and self._offset == self._input_size",function(t){t.return_("tree")}),e.if_("not self._expected",function(t){t.assign_("self._failure","self._offset"),t.append_("self._expected","'<EOF>'")}),e._line("raise ParseError(format_error(self._input, self._failure, self._expected))")})}),this._line("def format_error(input, offset, expected):"),this._indent(function(t){t._line("lines, line_no, position = input.split('\\n'), 0, 0"),t._line("while position <= offset:"),t._indent(function(t){t._line("position += len(lines[line_no]) + 1"),t._line("line_no += 1")}),t._line("message, line = 'Line ' + str(line_no) + ': expected ' + ', '.join(expected) + '\\n', lines[line_no - 1]"),t._line("message += line + '\\n'"),t._line("position -= len(line) + 1"),t._line("message += ' ' * (offset - position)"),t.return_("message + '^'")}),this._newline()},exports_:function(){this._line("def parse(input, actions=None, types=None):"),this._indent(function(t){t.assign_("parser","Parser(input, actions, types)"),t.return_("parser.parse()")})},class_:function(e,s,i,n){this._line("class "+e+"("+s+"):"),new t(this,e,s)._indent(i,n),this._newline(),this._newline()},constructor_:function(t,e,s){this.method_("__init__",t,function(i){i._line("super("+this._name+", self).__init__("+t.join(", ")+")"),e.call(s,i)},this)},method_:function(e,s,i,n){this._write(this._methodSeparator),this._methodSeparator="\n",
s=["self"].concat(s).join(", "),this._line("def "+e+"("+s+"):"),new t(this)._indent(i,n)},cache_:function(t,e,s){var i=this.localVars_({address:this.nullNode_(),index:"self._offset"}),n=i.address,_=i.index,f="self._cache['"+t+"']",h=f+"["+_+"]";this.assign_("cached",f+".get("+_+")"),this.if_("cached",function(t){t.assign_("self._offset","cached[1]"),t.return_("cached[0]")}),e.call(s,this,n),this.assign_(h,"("+n+", self._offset)"),this.return_(n)},attributes_:function(){},attribute_:function(t,e){this.assign_("self."+t,e)},localVars_:function(t){var e,s={},i=[],n=[];for(var _ in t)this._varIndex[_]=this._varIndex[_]||0,e=_+this._varIndex[_],this._varIndex[_]+=1,i.push(e),n.push(t[_]),s[_]=e;return this.assign_(i.join(", "),n.join(", ")),s},localVar_:function(t,e){this._varIndex[t]=this._varIndex[t]||0;var s=t+this._varIndex[t];return this._varIndex[t]+=1,this.assign_(s,void 0===e?this.nullNode_():e),s},chunk_:function(t){var e=this.localVar_("chunk",this.null_()),s="self._input",i="self._offset";return this.if_(i+" < self._input_size",function(n){n.assign_(e,s+"["+i+":"+i+" + "+t+"]")}),e},syntaxNode_:function(t,e,s,i,n,_){var f;n?(n="self._actions."+n,f=["self._input",e,s]):(n=_||"TreeNode",f=["self._input["+e+":"+s+"]",e]),i&&f.push(i),this.assign_(t,n+"("+f.join(", ")+")"),this.assign_("self._offset",s)},ifNode_:function(t,e,s,i){this.if_(t+" is not "+this.nullNode_(),e,s,i)},unlessNode_:function(t,e,s,i){this.if_(t+" is "+this.nullNode_(),e,s,i)},ifNull_:function(t,e,s,i){this.if_(t+" is None",e,s,i)},extendNode_:function(t,e){if(e){var s=this.localVar_("cls","type("+t+")");this.assign_(t+".__class__","type("+s+".__name__ + '"+e+"', ("+s+", self._types."+e+"), {})")}},failure_:function(t,e){e=this._quote(e),this.assign_(t,this.nullNode_()),this.if_("self._offset > self._failure",function(t){t.assign_("self._failure","self._offset"),t.assign_("self._expected","[]")}),this.if_("self._offset == self._failure",function(t){t.append_("self._expected",e)})},assign_:function(t,e){this._line(t+" = "+e)},jump_:function(t,e){this.assign_(t,"self._read_"+e+"()")},if_:function(t,e,s,i){"function"!=typeof s&&(i=s,s=null),this._line("if "+t+":"),this._indent(e,i),s&&(this._line("else:"),this._indent(s,i))},whileNotNull_:function(t,e,s){this._line("while "+t+" is not "+this.nullNode_()+":"),this._indent(e,s)},stringMatch_:function(t,e){return t+" == "+this._quote(e)},stringMatchCI_:function(t,e){return t+" is not None and "+t+".lower() == "+this._quote(e)+".lower()"},regexMatch_:function(t,e){return e+" is not None and Grammar."+t+".search("+e+")"},return_:function(t){this._line("return "+t)},arrayLookup_:function(t,e){return t+"["+e+"]"},append_:function(t,e){this._line(t+".append("+e+")")},decrement_:function(t){this._line(t+" -= 1")},hasChars_:function(){return"self._offset < self._input_size"},isZero_:function(t){return t+" <= 0"},nullNode_:function(){return"FAILURE"},offset_:function(){return"self._offset"},emptyList_:function(){return"[]"},emptyString_:function(){return"''"},true_:function(){return"True"},null_:function(){return"None"}}),Canopy.Builders.Python=t}(),function(){var t=function(t){t?(this._parent=t,this._indentLevel=t._indentLevel):(this._buffer="",this._indentLevel=0),this._methodSeparator="",this._varIndex={}};t.create=function(e){var s=new t;return s.filename=e,s},Canopy.extend(t.prototype,{serialize:function(){var t={};return t[this._outputPathname()]=this._buffer,t},_outputPathname:function(){return this.filename.replace(/\.peg$/,".rb")},_write:function(t){return this._parent?this._parent._write(t):void(this._buffer+=t)},_indent:function(t,e){this._indentLevel+=1,t.call(e,this),this._indentLevel-=1},_newline:function(){this._write("\n")},_line:function(t){for(var e=this._indentLevel;e--;)this._write("  ");this._write(t),this._newline()},_quote:function(t){return t=t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/#\{/g,"\\#{").replace(/\x07/g,"\\a").replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\v/g,"\\v").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/\x1b/g,"\\e"),'"'+t+'"'},package_:function(t,e,s){this._line("module "+t.replace(/\./g,"::")),this._indent(e,s),this._line("end")},syntaxNodeClass_:function(){var t="TreeNode";return this._line("class "+t),this._indent(function(t){t._line("include Enumerable"),t.attributes_(["text","offset","elements"]),t.method_("initialize",["text","offset","elements = []"],function(t){t.attribute_("text","text"),t.attribute_("offset","offset"),t.attribute_("elements","elements")}),t.method_("each",["&block"],function(t){t._line("@elements.each(&block)")})}),this._line("end"),this._newline(),t},grammarModule_:function(e,s,i){this.assign_("ParseError","Class.new(StandardError)"),this._newline(),this.assign_(this.nullNode_(),"Object.new"),this._newline(),this._line("module Grammar"),new t(this)._indent(s,i),this._line("end"),this._newline()},compileRegex_:function(){},parserClass_:function(t){this._line("class Parser"),this._indent(function(e){e._line("include Grammar"),e._methodSeparator="\n",e.method_("initialize",["input","actions","types"],function(t){t.attribute_("input","input"),t.attribute_("input_size","input.size"),t.attribute_("actions","actions"),t.attribute_("types","types"),t.attribute_("offset","0"),t.attribute_("cache","Hash.new { |h,k| h[k] = {} }"),t.attribute_("failure","0"),t.attribute_("expected","[]")}),e.method_("parse",[],function(e){e.jump_("tree",t),e.if_("tree != "+e.nullNode_()+" and @offset == @input_size",function(t){t.return_("tree")}),e.if_("@expected.empty?",function(t){t.assign_("@failure","@offset"),t.append_("@expected",'"<EOF>"')}),e._line("raise ParseError, Parser.format_error(@input, @failure, @expected)")}),e.method_("self.format_error",["input","offset","expected"],function(t){t._line("lines, line_no, position = input.split(/\\n/), 0, 0"),t._line("while position <= offset"),t._indent(function(t){t._line("position += lines[line_no].size + 1"),t._line("line_no += 1")}),t._line("end"),t._line('message, line = "Line #{line_no}: expected #{expected * ", "}\\n", lines[line_no - 1]'),t._line('message += "#{line}\\n"'),t._line("position -= line.size + 1"),t._line('message += " " * (offset - position)'),t.return_('message + "^"')})}),this._line("end"),this._newline()},exports_:function(){this._line("def self.parse(input, options = {})"),this._indent(function(t){t.assign_("parser","Parser.new(input, options[:actions], options[:types])"),t._line("parser.parse")}),this._line("end")},class_:function(e,s,i,n){this._line("class "+e+" < "+s),new t(this)._indent(i,n),this._line("end"),this._newline()},constructor_:function(t,e,s){this.method_("initialize",t,function(t){t._line("super"),e.call(s,t)})},method_:function(e,s,i,n){this._write(this._methodSeparator),this._methodSeparator="\n",s=s.length>0?"("+s.join(", ")+")":"",this._line("def "+e+s),new t(this)._indent(i,n),this._line("end")},cache_:function(t,e,s){var i=this.localVars_({address:this.nullNode_(),index:"@offset"}),n=i.address,_=i.index,f="@cache[:"+t+"]",h=f+"["+_+"]";this.assign_("cached",h),this.if_("cached",function(t){t._line("@offset = cached[1]"),t.return_("cached[0]")},this),e.call(s,this,n),this.assign_(h,"["+n+", @offset]"),this.return_(n)},attributes_:function(t){for(var e=[],s=0,i=t.length;i>s;s++)e.push(":"+t[s]);this._line("attr_reader "+e.join(", ")),this._methodSeparator="\n"},attribute_:function(t,e){this.assign_("@"+t,e)},localVars_:function(t){var e,s={},i=[],n=[];for(var _ in t)this._varIndex[_]=this._varIndex[_]||0,e=_+this._varIndex[_],this._varIndex[_]+=1,i.push(e),n.push(t[_]),s[_]=e;return this.assign_(i.join(", "),n.join(", ")),s},localVar_:function(t,e){this._varIndex[t]=this._varIndex[t]||0;var s=t+this._varIndex[t];return this._varIndex[t]+=1,this.assign_(s,void 0===e?this.nullNode_():e),s},chunk_:function(t){var e=this.localVar_("chunk",this.null_()),s="@input",i="@offset";return this.if_(i+" < @input_size",function(n){n.assign_(e,s+"["+i+"..."+i+" + "+t+"]")}),e},syntaxNode_:function(t,e,s,i,n,_){var f;n?(n="@actions."+n,f=["@input",e,s]):(n=(_||"TreeNode")+".new",f=["@input["+e+"..."+s+"]",e]),i&&f.push(i),this.assign_(t,n+"("+f.join(", ")+")"),this.assign_("@offset",s)},ifNode_:function(t,e,s,i){this.unless_(t+" == "+this.nullNode_(),e,s,i)},unlessNode_:function(t,e,s,i){this.if_(t+" == "+this.nullNode_(),e,s,i)},ifNull_:function(t,e,s,i){this.if_(t+".nil?",e,s,i)},extendNode_:function(t,e){e&&this._line(t+".extend(@types::"+e.replace(/\./g,"::")+")")},failure_:function(t,e){e=this._quote(e),this.assign_(t,this.nullNode_()),this.if_("@offset > @failure",function(t){t.assign_("@failure","@offset"),t.assign_("@expected","[]")}),this.if_("@offset == @failure",function(t){t.append_("@expected",e)})},assign_:function(t,e){this._line(t+" = "+e)},jump_:function(t,e){this.assign_(t,"_read_"+e)},conditional_:function(t,e,s,i,n){"function"!=typeof i&&(n=i,i=null),this._line(t+" "+e),this._indent(s,n),i&&(this._line("else"),this._indent(i,n)),this._line("end")},if_:function(t,e,s,i){this.conditional_("if",t,e,s,i)},unless_:function(t,e,s,i){this.conditional_("unless",t,e,s,i)},whileNotNull_:function(t,e,s){this._line("until "+t+" == "+this.nullNode_()),this._indent(e,s),this._line("end")},stringMatch_:function(t,e){return t+" == "+this._quote(e)},stringMatchCI_:function(t,e){return"!"+t+".nil? && "+t+".downcase == "+this._quote(e)+".downcase"},regexMatch_:function(t,e){var s=t.source.replace(/^\^/g,"\\A");return e+" =~ /"+s+"/"},return_:function(t){this._line("return "+t)},arrayLookup_:function(t,e){return t+"["+e+"]"},append_:function(t,e){this._line(t+" << "+e)},decrement_:function(t){this._line(t+" -= 1")},hasChars_:function(){return"@offset < @input_size"},isZero_:function(t){return t+" <= 0"},nullNode_:function(){return"FAILURE"},offset_:function(){return"@offset"},emptyList_:function(){return"[]"},emptyString_:function(){return'""'},true_:function(){return"true"},null_:function(){return"nil"}}),Canopy.Builders.Ruby=t}(),Canopy.Compiler=function(t,e){this._grammarText=t,this._builder=e},Canopy.extend(Canopy.Compiler.prototype,{parseTree:function(){if(this._tree)return this._tree;var t,e=Canopy.MetaGrammar;if(this._tree=e.parse(this._grammarText,{types:Canopy.Compiler}),this._tree)return this._tree;throw t=e.formatError(e.Parser.lastError),Error(t)},toSexp:function(){return this.parseTree().toSexp()},toSource:function(){return this.parseTree().compile(this._builder),this._builder.serialize()}}),Canopy.Compiler.Grammar={grammarName:function(){return this.grammar_name.object_identifier.text},toSexp:function(){var t=["grammar",this.grammarName()];return this.rules.forEach(function(e){t.push(e.grammar_rule.toSexp())}),t},compile:function(t){var e=function(t,s,i){s.call(i,t),t.forEach(function(t){e(t,s,i)})};t.package_(this.grammarName(),function(t){var s=[];e(this,function(t){t.action_tag&&s.push(t.action_tag.identifier.text)});var i=t.syntaxNodeClass_(),n=1;e(this,function(e){var s=i+n,_=e.collectLabels&&e.collectLabels(s);_&&(t.class_(s,i,function(t){var e=[];for(var s in _)e.push(s);t.attributes_(e),t.constructor_(["text","offset","elements"],function(t){for(var e in _)t.attribute_(e,t.arrayLookup_("elements",_[e]))})}),n+=1)}),t.grammarModule_(s.sort(),function(t){var s="REGEX_",i=1;e(this,function(e){e.regex&&t.compileRegex_(e,s+i++)}),this.rules.forEach(function(e){e.grammar_rule.compile(t)})},this);var _=this.rules.elements[0].grammar_rule.name();t.parserClass_(_),t.exports_()},this)}},Canopy.Compiler.GrammarRule={name:function(){return this.identifier.text},toSexp:function(){return["rule",this.name(),this.parsing_expression.toSexp()]},compile:function(t){var e=this.name();t.method_("_read_"+e,[],function(t){t.cache_(e,function(t,e){this.parsing_expression.compile(t,e)},this)},this)}},Canopy.Compiler.Choice={expressions:function(){return this._expressions?this._expressions:(this._expressions=[this.first_part],this.rest.forEach(function(t){this._expressions.push(t.expression)},this),this._expressions)},toSexp:function(){var t=["choice"];return Canopy.forEach(this.expressions(),function(e){t.push(e.toSexp())}),t},compile:function(t,e){var s=t.localVar_("index",t.offset_());this._compileChoices(t,0,e,s)},_compileChoices:function(t,e,s,i){var n=this.expressions();e!==n.length&&(n[e].compile(t,s),t.unlessNode_(s,function(t){t.assign_(t.offset_(),i),this._compileChoices(t,e+1,s,i)},this))}},Canopy.Compiler.ChoicePart={nodeType:function(){var t=this.elements[1].type_tag;return t?t.object_identifier.text:null},toSexp:function(){var t,e=this.elements[0].toSexp();return(t=this.nodeType())&&(e=["type",t,e]),e},compile:function(t,e){this.elements[0].compile(t,e),t.extendNode_(e,this.nodeType())}},Canopy.Compiler.Action={expression:function(){for(var t=this;t.actionable_expression;)t=t.actionable_expression;return t},actionName:function(){return this.action_tag.identifier.text},toSexp:function(){return["action",this.actionName(),this.expression().toSexp()]},compile:function(t,e){this.expression().compile(t,e,this.actionName())}},Canopy.Compiler.AnyChar={toSexp:function(){return["any-char"]},compile:function(t,e,s){t.if_(t.hasChars_(),function(t){var i=t.offset_();t.syntaxNode_(e,i,i+" + 1",null,s)},function(t){t.failure_(e,"<any char>")})}},Canopy.Compiler.CharClass={regex:!0,toRegExp:function(){return RegExp("^"+this.text)},toSexp:function(){return["char-class",this.text]},compile:function(t,e,s){var i=this.constName||this.toRegExp(),n=t.chunk_(1);t.if_(t.regexMatch_(i,n),function(t){var i=t.offset_();t.syntaxNode_(e,i,i+" + 1",null,s)},function(t){t.failure_(e,this.text)},this)}},Canopy.Compiler.String={toSexp:function(){return["string",eval(this.text)]},compile:function(builder,address,action){var string=eval(this.text),length=string.length,chunk=builder.chunk_(length);builder.if_(builder.stringMatch_(chunk,string),function(t){var e=t.offset_();t.syntaxNode_(address,e,e+" + "+length,null,action)},function(t){t.failure_(address,this.text)},this)}},Canopy.Compiler.CIString={toSexp:function(){return["ci-string",this.stringValue()]},compile:function(t,e,s){var i=this.stringValue(),n=i.length,_=t.chunk_(n);t.if_(t.stringMatchCI_(_,i),function(t){var i=t.offset_();t.syntaxNode_(e,i,i+" + "+n,null,s)},function(t){t.failure_(e,this.text)},this)},stringValue:function(){var string='"'+this.elements[1].text+'"';return eval(string)}},Canopy.Compiler.Predicate={atomic:function(){var t=this.atom;return t.parsing_expression||t},toSexp:function(){var t=this.atomic(),e={"&":"and","!":"not"},s=e[this.predicate.text];return[s,t.toSexp()]},compile:function(t,e){var s=t.localVar_("index",t.offset_()),i={"&":"ifNode_","!":"unlessNode_"},n=i[this.predicate.text];this.atomic().compile(t,e),t.assign_(t.offset_(),s),t[n](e,function(t){var s=t.offset_();t.syntaxNode_(e,s,s,null)},function(t){t.assign_(e,t.nullNode_())})}},Canopy.Compiler.Maybe={atomic:function(){var t=this.atom;return t.parsing_expression||t},toSexp:function(){var t=this.atomic(),e=t.toSexp();return["maybe",e]},compile:function(t,e){var s=t.localVar_("index",t.offset_());this.atomic().compile(t,e),t.unlessNode_(e,function(t){t.syntaxNode_(e,s,s,null)})}},Canopy.Compiler.Repeat={QUANTITIES:{"*":0,"+":1},atomic:function(){var t=this.atom;return t.parsing_expression||t},toSexp:function(){var t=this.atomic(),e=t.toSexp();switch(this.quantifier.text){case"*":e=["repeat",0,e];break;case"+":e=["repeat",1,e]}return e},compile:function(t,e,s){var i=this.quantifier.text,n=this.QUANTITIES[i],_=t.localVars_({remaining:n,index:t.offset_(),elements:t.emptyList_(),address:t.true_()}),f=_.remaining,h=_.index,o=_.elements,r=_.address;t.whileNotNull_(r,function(t){this.atomic().compile(t,r),t.ifNode_(r,function(t){t.append_(o,r),t.decrement_(f)})},this),t.if_(t.isZero_(f),function(t){t.syntaxNode_(e,h,t.offset_(),o,s)},function(t){t.assign_(e,t.nullNode_())})}},Canopy.Compiler.Sequence={expressions:function(){return this._expressions?this._expressions:(this._expressions=[this.first_part],this.rest.forEach(function(t){this._expressions.push(t.expression)},this),this._expressions)},toSexp:function(){var t=["sequence"];return Canopy.forEach(this.expressions(),function(e){t.push(e.toSexp())}),t},collectLabels:function(t){var e,s,i,n,_,f=this.expressions(),h={},o=!1;for(s=0,_=f.length;_>s;s++)if(e=f[s].labels(),0!==e.length)for(o=!0,i=0,n=e.length;n>i;i++)h[e[i]]=s;return o?(this._nodeClassName=t,h):null},compile:function(t,e,s){var i=t.localVars_({index:t.offset_(),elements:t.emptyList_(this.expressions().length)}),n=i.index,_=i.elements;this._compileExpressions(t,0,n,_),t.ifNull_(_,function(t){t.assign_(e,t.nullNode_())},function(t){t.syntaxNode_(e,n,t.offset_(),_,s,this._nodeClassName)},this)},_compileExpressions:function(t,e,s,i){var n=this.expressions();if(e!==n.length){var _=t.localVar_("address");n[e].compile(t,_),t.ifNode_(_,function(t){t.append_(i,_,e),this._compileExpressions(t,e+1,s,i)},function(t){t.assign_(i,t.null_()),t.assign_(t.offset_(),s)},this)}}},Canopy.Compiler.SequencePart={atomic:function(){var t=this.expression;return t.parsing_expression||t},labels:function(){var t=this.elements[0].identifier,e=this.atomic(),s=[];return t&&s.push(t.text),e.referenceName&&s.push(e.referenceName()),s},toSexp:function(){var t=this.atomic(),e=this.labels(),s=t.toSexp();return this.elements[0].identifier&&(s=["label",e[0],s]),s},compile:function(t,e){return this.atomic().compile(t,e)}},Canopy.Compiler.Reference={referenceName:function(){return this.identifier.text},toSexp:function(){return["reference",this.referenceName()]},compile:function(t,e){t.jump_(e,this.referenceName())}},function(){for(var t in Canopy.Compiler)/^[A-Z]/.test(t)&&(Canopy.MetaGrammar.Parser[t]=Canopy.Compiler[t]);"object"==typeof exports&&(module.exports=exports,Canopy.extend(exports,Canopy),exports.compile=Canopy.compile)}();
//# sourceMappingURL=canopy-min.js.map